<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4f46e5">
<meta name="description" content="Swift POS System for inventory and sales management">
<title>Swift POS - Internal System</title>
<link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').catch(function(err){
      console.error('Service worker registration failed:', err);
    });
  });
}
</script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Helvetica:wght@400;500;600;700&display=swap');

body {
font-family: 'Helvetica', 'Inter', sans-serif;
background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
min-height: 100vh;
margin: 0;
padding: 0;
}

.myanmar-font {
font-family: 'Noto Sans Myanmar', sans-serif;
}

.active-tab {
background-color: #1a3a6e;
color: white;
}

.product-card:hover {
transform: translateY(-3px);
box-shadow: 0 10px 15px 3px rgba(0, 0, 0, 0.1);
}

.custom-scrollbar::-webkit-scrollbar {
width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
background: #c5c5c5;
border-radius: 10px;
}

.receipt-card {
border: 2px dashed #9ca3af;
border-radius: 0.5rem;
padding: 1rem;
background-color: #f9fafb;
}

@media print {
body * {
visibility: hidden;
}
.receipt,
.receipt * {
visibility: visible;
}
.receipt {
position: absolute;
left: 0;
top: 0;
width: 80mm;
padding: 1rem;
}
.no-print {
display: none !important;
}
}

/* Mobile Responsive Navigation */
.mobile-nav {
display: none;
}

@media (max-width: 768px) {
.mobile-nav {
display: block;
}
.desktop-nav {
display: none;
}
.main-content {
padding-top: 0;
}
.sidebar {
position: fixed;
left: -250px;
top: 0;
height: 100%;
width: 250px;
background: white;
z-index: 1000;
transition: left 0.3s ease;
box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar.open {
left: 0;
}
.overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 999;
}
.overlay.open {
display: block;
}
.menu-button {
display: block;
position: fixed;
top: 10px;
left: 10px;
z-index: 1001;
background: #4f46e5;
color: white;
border: none;
border-radius: 50%;
width: 40px;
height: 40px;
display: flex;
align-items: center;
justify-content: center;
}
}

/* Accessibility improvements */
.skip-link {
position: absolute;
top: -40px;
left: 6px;
background: #4f46e5;
color: white;
padding: 8px;
z-index: 100;
transition: top 0.3s;
}

.skip-link:focus {
top: 6px;
}

/* Focus styles for keyboard navigation */
button:focus,
input:focus,
select:focus,
textarea:focus {
outline: 3px solid #1a3a6e;
outline-offset: 2px;
}

/* Improved responsive design */
@media (max-width: 640px) {
.company-header {
flex-direction: column;
text-align: center;
gap: 0.5rem;
}
.company-info {
flex-direction: column;
}
.btn-mobile {
padding: 12px;
min-height: 44px;
min-width: 44px;
}
}

/* Status indicator for offline/online mode */
.status-indicator {
display: inline-block;
width: 10px;
height: 10px;
border-radius: 50%;
margin-right: 5px;
}

.status-online {
background-color: #10b981;
}

.status-offline {
background-color: #ef4444;
}

/* Expense category styling */
.expense-category {
border-left: 4px solid #4f46e5;
padding-left: 1rem;
margin-bottom: 1.5rem;
}

.category-header {
font-weight: 600;
color: #374151;
margin-bottom: 0.5rem;
}
</style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start p-0 min-h-screen">
<!-- Skip link for keyboard users -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Mobile menu button -->
<button class="menu-button md:hidden" id="mobileMenuButton" aria-label="Open menu">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
</svg>
</button>

<!-- Overlay for mobile menu -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar for mobile -->
<div class="sidebar md:hidden" id="sidebar">
<div class="p-4 border-b">
<div class="flex justify-between items-center">
<h2 class="text-lg font-semibold">Menu</h2>
<button id="closeSidebar" aria-label="Close menu">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
</svg>
</button>
</div>
</div>
<nav class="p-4">
<button id="mobileDashboardTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5a9.5 9.5 0 0115.3-7.5l-3.2 3.2m-12 0l3.2-3.2m-3.2 3.2a9.5 9.5 0 0115.3 7.5l-3.2-3.2M7.2 12.8a.8.8 0 100-1.6.8.8 0 000 1.6z" />
</svg>
Dashboard
</button>
<button id="mobileProductsTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
</svg>
Products
</button>
<button id="mobileSalesTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5h.007m-7.5 0h.007m7.5 0a.75.75 0 110 1.5.75.75 0 010-1.5zM12 12.75a.75.75 0 110 1.5.75.75 0 010-1.5zM4.5 18a.75.75 0 110 1.5.75.75 0 010-1.5z" />
</svg>
Sales
</button>
<button id="mobileSuppliersTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m18-6H3l9-9m0 18v-12" />
</svg>
Suppliers
</button>
<button id="mobileExpensesTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
Expenses
</button>
<button id="mobileCustomersTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M15 9h-2.25a.75.75 0 000 1.5H15V9z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9h2.25a.75.75 0 000 1.5H8.25V9z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15h2.25a.75.75 0 000 1.5H8.25V15z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15h2.25a.75.75 0 000 1.5H12.75V15z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21L15 15" />
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21h-6v-6" />
</svg>
Customers
</button>
<button id="mobileReportsTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M10 20.5v-10h4v10M10 14.5v-4h4v4M10 18.5v-4h4v4" />
</svg>
Reports
</button>
<button id="mobileSettingsTab" class="w-full text-left py-2 px-4 rounded-lg mb-2 flex items-center">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 6a6 6 0 100 12 6 6 0 000-12z" />
</svg>
Settings
</button>
</nav>
</div>

<!-- Top Navigation Bar (Mobile & Desktop) -->
<header class="w-full bg-white shadow-lg z-10">
<!-- Desktop Navigation -->
<nav class="desktop-nav flex justify-center space-x-1 p-2" aria-label="Main navigation">
<button id="dashboardTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200 active-tab" aria-current="page" data-lang-key="dashboard">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5a9.5 9.5 0 0115.3-7.5l-3.2 3.2m-12 0l3.2-3.2m-3.2 3.2a9.5 9.5 0 0115.3 7.5l-3.2-3.2M7.2 12.8a.8.8 0 100-1.6.8.8 0 000 1.6z" />
</svg>
Dashboard
</button>
<button id="productsTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="products">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
</svg>
Products
</button>
<button id="salesTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="sales">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5h.007m-7.5 0h.007m7.5 0a.75.75 0 110 1.5.75.75 0 010-1.5zM12 12.75a.75.75 0 110 1.5.75.75 0 010-1.5zM4.5 18a.75.75 0 110 1.5.75.75 0 010-1.5z" />
</svg>
Sales
</button>
<button id="suppliersTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="suppliers">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m18-6H3l9-9m0 18v-12" />
</svg>
Suppliers
</button>
<button id="expensesTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="expenses">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
Expenses
</button>
<button id="customersTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="customers">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M15 9h-2.25a.75.75 0 000 1.5H15V9z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9h2.25a.75.75 0 000 1.5H8.25V9z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15h2.25a.75.75 0 000 1.5H8.25V15z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15h2.25a.75.75 0 000 1.5H12.75V15z" />
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21L15 15" />
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21h-6v-6" />
</svg>
Customers
</button>
<button id="reportsTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="reports">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M10 20.5v-10h4v10M10 14.5v-4h4v4M10 18.5v-4h4v4" />
</svg>
Reports
</button>
<button id="settingsTab" class="flex items-center px-4 py-3 text-sm font-medium rounded-t-lg hover:bg-gray-200 transition-colors duration-200" data-lang-key="settings">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 6a6 6 0 100 12 6 6 0 000-12z" />
</svg>
Settings
</button>
</nav>

<!-- Mobile Navigation -->
<div class="mobile-nav md:hidden bg-gray-50 p-2">
<label for="mobileNavSelect" class="sr-only">Select a section</label>
<select id="mobileNavSelect" class="w-full p-3 text-sm font-medium border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Mobile navigation">
<option value="dashboard">Dashboard</option>
<option value="products">Products</option>
<option value="sales">Sales</option>
<option value="suppliers">Suppliers</option>
<option value="expenses">Expenses</option>
<option value="customers">Customers</option>
<option value="reports">Reports</option>
<option value="settings">Settings</option>
</select>
</div>
</header>

<!-- Connection Status Indicator -->
<div class="w-full bg-yellow-100 text-yellow-800 py-2 px-4 text-center hidden" id="offlineIndicator">
<span class="status-indicator status-offline"></span>
<span id="offlineMessage">You are currently offline. Changes will be synced when connection is restored.</span>
</div>

<!-- Main Content Area -->
<main id="main-content" class="main-content flex-grow w-full max-w-7xl mx-auto bg-gray-50 p-4 md:p-6 shadow-inner relative overflow-y-auto">
<!-- Dashboard View -->
<div id="dashboardView" class="view" aria-labelledby="dashboard-heading">
<!-- Permanent Header -->
<div class="w-full bg-white shadow-md flex items-center justify-between p-2">
    <div class="flex items-center">
        <img src="https://i.imgur.com/bSIz7z5.png" alt="Swift POS Logo" class="h-12 mr-4">
    </div>
    <div class="current-date" id="currentDate"></div>
</div>

<h2 id="dashboard-heading" class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
<div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
<h3 class="text-sm font-medium text-gray-500">Total Sales</h3>
<p class="text-3xl font-bold text-gray-900 mt-2" id="totalSales">0 MMK</p>
</div>
<div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
<h3 class="text-sm font-medium text-gray-500">Total Profit</h3>
<p class="text-3xl font-bold text-gray-900 mt-2" id="totalProfit">0 MMK</p>
</div>
<div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
<h3 class="text-sm font-medium text-gray-500">Total Products</h3>
<p class="text-3xl font-bold text-gray-900 mt-2" id="totalProducts">0</p>
</div>
<div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
<h3 class="text-sm font-medium text-gray-500">Credit Payments</h3>
<p class="text-3xl font-bold text-red-500 mt-2" id="totalCreditPayments">0 MMK</p>
</div>
</div>
<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Sales Trends (Last 7 Days)</h3>
<canvas id="salesChart" aria-label="Sales trends chart for the last 7 days" role="img"></canvas>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Monthly Profit</h3>
<canvas id="monthlyProfitChart" aria-label="Monthly profit chart" role="img"></canvas>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 Best-Selling Products</h3>
<canvas id="bestSellingProductsChart" aria-label="Top 5 best-selling products chart" role="img"></canvas>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Sales by Category</h3>
<canvas id="salesByCategoryChart" aria-label="Sales by category chart" role="img"></canvas>
</div>
</div>
<!-- New Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
    <div class="bg-white rounded-lg p-6 shadow-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Monthly Revenue vs. Profit & Expense %</h3>
        <canvas id="monthlyFinancialsChart" aria-label="Monthly revenue, and profit and expense percentages chart" role="img"></canvas>
    </div>
    <div class="bg-white rounded-lg p-6 shadow-md">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Monthly Expenses by Category</h3>
        <canvas id="monthlyExpensesByCategoryChart" aria-label="Monthly expenses by category chart" role="img"></canvas>
    </div>
</div>
<!-- Additional Analytics Section -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
<!-- Top 10 Selling Items -->
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 Selling Items</h3>
<div id="topSellingItems" class="space-y-2">
<!-- Top selling items will be rendered here -->
<p class="text-gray-500 text-center">No sales data available</p>
</div>
</div>

<!-- Low Stock Items -->
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Low Stock Items</h3>
<div id="lowStockItems" class="space-y-2">
<!-- Low stock items will be rendered here -->
<p class="text-gray-500 text-center">No low stock items</p>
</div>
</div>

<!-- Least Selling Items -->
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Least Selling Items</h3>
<div id="leastSellingItems" class="space-y-2">
<!-- Least selling items will be rendered here -->
<p class="text-gray-500 text-center">No sales data available</p>
</div>
</div>
</div>
<!-- Supplier Payments Section -->
<div class="bg-white rounded-lg p-6 shadow-md mt-6">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Supplier Payments</h3>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
</tr>
</thead>
<tbody id="supplierPaymentsDashboard">
<!-- Supplier payments will be rendered here -->
<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No recent payments</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Products View -->
<div id="productsView" class="view hidden" aria-labelledby="products-heading">
<h2 id="products-heading" class="text-3xl font-bold text-gray-900 mb-6">Product Management</h2>
<div class="bg-white rounded-lg p-6 shadow-md mb-6">
<form id="productForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<input type="hidden" id="productId">
<div class="flex flex-col">
<label for="productName" class="text-sm font-medium text-gray-700 mb-1">Product Name</label>
<input type="text" id="productName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="productImage" class="text-sm font-medium text-gray-700 mb-1">Product Image</label>
<input type="file" id="productImage" accept="image/*" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
		<label for="productCategory" class="text-sm font-medium text-gray-700 mb-1">Category</label>
		<div class="flex gap-2">
			<select id="productCategory" required class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
				<option value="">Select Category</option>
			</select>
			<input type="text" id="newCategoryInput" placeholder="New category" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
			<button type="button" id="addCategoryButton" class="bg-blue-900 text-white px-4 rounded-lg">Add</button>
		</div>
</div>
<div class="flex flex-col">
<label for="productStock" class="text-sm font-medium text-gray-700 mb-1">Stock</label>
<input type="number" id="productStock" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="productBuyingPrice" class="text-sm font-medium text-gray-700 mb-1">Buying Price (MMK)</label>
<input type="number" id="productBuyingPrice" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="productSellingPrice" class="text-sm font-medium text-gray-700 mb-1">Selling Price (MMK)</label>
<input type="number" id="productSellingPrice" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="productSize" class="text-sm font-medium text-gray-700 mb-1">Size</label>
<input type="text" id="productSize" placeholder="e.g., S, M, L or 38" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="productColor" class="text-sm font-medium text-gray-700 mb-1">Color</label>
<input type="text" id="productColor" placeholder="e.g., Red" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="productSupplier" class="text-sm font-medium text-gray-700 mb-1">Supplier</label>
<select id="productSupplier" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<option value="">Select a supplier</option>
</select>
</div>
<div class="flex flex-col">
<label for="productBarcode" class="text-sm font-medium text-gray-700 mb-1">Barcode</label>
<input type="text" id="productBarcode" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex items-end col-span-1 md:col-span-2 lg:col-span-3 space-x-4">
<button type="submit" class="bg-blue-900 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-800 transition-colors duration-200">Save Product</button>
<button type="button" id="productClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
</div>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
<h3 class="text-xl font-semibold text-gray-800">Product List</h3>
<div class="flex space-x-2 w-full md:w-auto">
<label for="productSearch" class="sr-only">Search products</label>
<input type="text" id="productSearch" placeholder="Search products..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-800">
<button id="productSearchButton" class="bg-blue-900 text-white p-2 rounded-lg hover:bg-blue-800 transition-colors duration-200" aria-label="Search products">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
</svg>
</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buying Price</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selling Price</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="productList" class="bg-white divide-y divide-gray-200">
<!-- Product list will be rendered here -->
<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No products added yet</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Sales View -->
<div id="salesView" class="view hidden" aria-labelledby="sales-heading">
<h2 id="sales-heading" class="text-3xl font-bold text-gray-900 mb-6">Sales</h2>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2">
<div class="bg-white rounded-lg p-6 shadow-md mb-6">
		<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div class="flex flex-col">
<label for="customerSelect" class="text-sm font-medium text-gray-700 mb-1">Customer</label>
<select id="customerSelect" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<option value="walk-in">Walk-in Customer</option>
<option value="online">Online Customer</option>
<!-- Customer options will be populated here -->
</select>
</div>
			<div class="flex flex-col">
				<label for="salesSearch" class="text-sm font-medium text-gray-700 mb-1">Search</label>
				<input type="text" id="salesSearch" placeholder="Search products..." class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
			</div>
</div>
		<div class="flex items-center gap-4">
			<div class="flex-1">
				<label class="text-sm font-medium text-gray-700 mb-1">Categories</label>
				<div id="salesCategoryChips" class="flex flex-wrap gap-2"></div>
			</div>
			<div class="flex-1">
				<label for="discountInput" class="text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
				<input type="number" id="discountInput" min="0" max="100" value="0" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
			</div>
		</div>
</div>
	<div class="bg-white rounded-lg p-6 shadow-md">
		<h3 class="text-xl font-semibold text-gray-800 mb-4">Products</h3>
		<div id="salesProductGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
			<!-- Product cards rendered here -->
			<p class="text-gray-500 col-span-full text-center">No products</p>
		</div>
		<h3 class="text-xl font-semibold text-gray-800 mb-4">Current Sale</h3>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discount</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="cartItems">
<!-- Cart items will be rendered here -->
<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No items in cart</td></tr>
</tbody>
</table>
</div>
<div class="flex justify-between items-center mt-4">
<div class="text-lg font-semibold text-gray-800">Total: <span id="cartTotal">0</span> MMK</div>
<button id="clearCartButton" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition-colors duration-200">Clear Cart</button>
</div>
</div>
</div>
<div class="lg:col-span-1">
<div class="bg-white rounded-lg p-6 shadow-md mb-6 receipt-card">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Receipt</h3>
<div id="receiptContent" class="receipt">
<div class="text-center mb-4">
<h4 class="font-bold text-lg" id="receiptCompanyName">Swift POS</h4>
<p class="text-sm" id="receiptDate"></p>
</div>
<div class="border-t border-b py-2 mb-4">
<div id="receiptItems">
<!-- Receipt items will be rendered here -->
<p class="text-center text-gray-500">No items</p>
</div>
</div>
<div class="flex justify-between font-semibold mb-2">
<span>Total:</span>
<span id="receiptTotal">0 MMK</span>
</div>
<div class="flex justify-between mb-2">
<span>Paid:</span>
<span id="receiptPaid">0 MMK</span>
</div>
<div class="flex justify-between font-semibold border-t pt-2">
<span>Change:</span>
<span id="receiptChange">0 MMK</span>
</div>
</div>
</div>

<div class="bg-white rounded-lg p-6 shadow-md mb-6">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Payment</h3>
<div class="space-y-4">
			<div class="flex flex-col">
				<label for="orderDiscount" class="text-sm font-medium text-gray-700 mb-1">Order Discount (%)</label>
				<input type="number" id="orderDiscount" min="0" max="100" value="0" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
			</div>
<div class="flex flex-col">
<label for="paymentMethod" class="text-sm font-medium text-gray-700 mb-1">Payment Method</label>
<select id="paymentMethod" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<option value="cash">Cash</option>
<option value="card">Card</option>
<option value="transfer">Bank Transfer</option>
</select>
</div>
<div class="flex flex-col">
<label for="amountPaid" class="text-sm font-medium text-gray-700 mb-1">Amount Paid (MMK)</label>
<input type="number" id="amountPaid" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="changeAmount" class="text-sm font-medium text-gray-700 mb-1">Change (MMK)</label>
<input type="number" id="changeAmount" readonly class="p-3 border border-gray-300 rounded-lg bg-gray-100">
</div>
<div class="flex flex-col">
<label for="saleNotes" class="text-sm font-medium text-gray-700 mb-1">Notes</label>
<textarea id="saleNotes" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
</div>
<div class="flex space-x-4">
<button id="completeSaleButton" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 flex-1">Complete Sale</button>
<button id="printReceiptButton" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 flex-1">Print Receipt</button>
</div>
</div>
</div>
 
</div>
</div>
</div>

<!-- Suppliers View -->
<div id="suppliersView" class="view hidden" aria-labelledby="suppliers-heading">
<h2 id="suppliers-heading" class="text-3xl font-bold text-gray-900 mb-6">Supplier Management</h2>
<div class="bg-white rounded-lg p-6 shadow-md mb-6">
<form id="supplierForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
<input type="hidden" id="supplierId">
<div class="flex flex-col">
<label for="supplierName" class="text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
<input type="text" id="supplierName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="supplierPhone" class="text-sm font-medium text-gray-700 mb-1">Phone Number</label>
<input type="tel" id="supplierPhone" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="supplierEmail" class="text-sm font-medium text-gray-700 mb-1">Email</label>
<input type="email" id="supplierEmail" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="supplierAddress" class="text-sm font-medium text-gray-700 mb-1">Address</label>
<textarea id="supplierAddress" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
</div>
<div class="flex items-end col-span-1 md:col-span-2 space-x-4">
<button type="submit" class="bg-blue-900 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-800 transition-colors duration-200">Save Supplier</button>
<button type="button" id="supplierClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
</div>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
<h3 class="text-xl font-semibold text-gray-800">Supplier List</h3>
<div class="flex space-x-2 w-full md:w-auto">
<label for="supplierSearch" class="sr-only">Search suppliers</label>
<input type="text" id="supplierSearch" placeholder="Search suppliers..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<button id="supplierSearchButton" class="bg-blue-900 text-white p-2 rounded-lg hover:bg-blue-800 transition-colors duration-200" aria-label="Search suppliers">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
</svg>
</button>
</div>
</div>

	<!-- Supplier Payment History & Totals -->
	<div class="bg-white rounded-lg p-6 shadow-md mt-6">
		<div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
			<div class="flex-1">
				<label for="supplierPaymentSelect" class="text-sm font-medium text-gray-700 mb-1">Select Supplier</label>
				<select id="supplierPaymentSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
					<option value="">Select a supplier</option>
				</select>
			</div>

			<div class="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1">
				<div class="p-4 bg-gray-50 rounded">
					<div class="text-xs text-gray-500">Total Pieces</div>
					<div id="supplierTotalPieces" class="text-lg font-semibold">0</div>
				</div>
				<div class="p-4 bg-gray-50 rounded">
					<div class="text-xs text-gray-500">Total Buying</div>
					<div id="supplierTotalBuying" class="text-lg font-semibold">0 MMK</div>
				</div>
				<div class="p-4 bg-gray-50 rounded">
					<div class="text-xs text-gray-500">Paid</div>
					<div id="supplierTotalPaid" class="text-lg font-semibold text-green-600">0 MMK</div>
				</div>
				<div class="p-4 bg-gray-50 rounded">
					<div class="text-xs text-gray-500">Remaining</div>
					<div id="supplierTotalRemaining" class="text-lg font-semibold text-red-600">0 MMK</div>
				</div>
			</div>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
			<div class="md:col-span-1">
				<h4 class="text-md font-semibold text-gray-800 mb-3">Record Payment</h4>
				<div class="space-y-3">
					<div class="flex flex-col">
						<label for="supplierPaymentAmount" class="text-sm font-medium text-gray-700 mb-1">Amount (MMK)</label>
						<input type="number" id="supplierPaymentAmount" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
					</div>
					<div class="flex flex-col">
						<label for="supplierPaymentDate" class="text-sm font-medium text-gray-700 mb-1">Date</label>
						<input type="date" id="supplierPaymentDate" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
					</div>
					<div class="flex flex-col">
						<label for="supplierPaymentNotes" class="text-sm font-medium text-gray-700 mb-1">Notes</label>
						<textarea id="supplierPaymentNotes" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Optional note..."></textarea>
					</div>
					<button id="addSupplierPaymentBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Add Payment</button>
				</div>
			</div>
			<div class="md:col-span-2">
				<div class="flex items-center justify-between mb-3">
					<h4 class="text-md font-semibold text-gray-800">Payment History</h4>
				</div>
				<div class="overflow-x-auto">
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-50">
							<tr>
								<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
								<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
								<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
								<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
							</tr>
						</thead>
						<tbody id="supplierPaymentHistoryBody" class="bg-white divide-y divide-gray-200">
							<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No payments recorded</td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="supplierList" class="bg-white divide-y divide-gray-200">
<!-- Supplier list will be rendered here -->
<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No suppliers added yet</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Expenses View -->
<div id="expensesView" class="view hidden" aria-labelledby="expenses-heading">
<h2 id="expenses-heading" class="text-3xl font-bold text-gray-900 mb-6">Expense Management</h2>
<div class="bg-white rounded-lg p-6 shadow-md mb-6">
<form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
<input type="hidden" id="expenseId">
<div class="flex flex-col">
<label for="expenseCategory" class="text-sm font-medium text-gray-700 mb-1">Category</label>
<select id="expenseCategory" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
<option value="">Select Category</option>
<option value="Rent">Rent</option>
<option value="Utilities">Utilities</option>
<option value="Salaries">Salaries</option>
<option value="Marketing">Marketing</option>
<option value="Supplies">Supplies</option>
<option value="Maintenance">Maintenance</option>
<option value="Other">Other</option>
</select>
</div>
<div class="flex flex-col">
<label for="expenseAmount" class="text-sm font-medium text-gray-700 mb-1">Amount (MMK)</label>
<input type="number" id="expenseAmount" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="expenseDate" class="text-sm font-medium text-gray-700 mb-1">Date</label>
<input type="date" id="expenseDate" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="expenseDescription" class="text-sm font-medium text-gray-700 mb-1">Description</label>
<textarea id="expenseDescription" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
</div>
<div class="flex items-end col-span-1 md:col-span-2 space-x-4">
<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Expense</button>
<button type="button" id="expenseClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
</div>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
<h3 class="text-xl font-semibold text-gray-800">Expense List</h3>
<div class="flex space-x-2 w-full md:w-auto">
<label for="expenseSearch" class="sr-only">Search expenses</label>
<input type="text" id="expenseSearch" placeholder="Search expenses..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<button id="expenseSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200" aria-label="Search expenses">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
</svg>
</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="expenseList" class="bg-white divide-y divide-gray-200">
<!-- Expense list will be rendered here -->
<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No expenses added yet</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Customers View -->
<div id="customersView" class="view hidden" aria-labelledby="customers-heading">
<h2 id="customers-heading" class="text-3xl font-bold text-gray-900 mb-6">Customer Management</h2>
<div class="bg-white rounded-lg p-6 shadow-md mb-6">
<form id="customerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
<input type="hidden" id="customerId">
<div class="flex flex-col">
<label for="customerName" class="text-sm font-medium text-gray-700 mb-1">Customer Name</label>
<input type="text" id="customerName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-required="true">
</div>
<div class="flex flex-col">
<label for="customerPhone" class="text-sm font-medium text-gray-700 mb-1">Phone Number</label>
<input type="tel" id="customerPhone" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="customerEmail" class="text-sm font-medium text-gray-700 mb-1">Email</label>
<input type="email" id="customerEmail" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="customerAddress" class="text-sm font-medium text-gray-700 mb-1">Address</label>
<textarea id="customerAddress" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
</div>
<div class="flex items-end col-span-1 md:col-span-2 space-x-4">
<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Customer</button>
<button type="button" id="customerClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
</div>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
<h3 class="text-xl font-semibold text-gray-800">Customer List</h3>
<div class="flex space-x-2 w-full md:w-auto">
<label for="customerSearch" class="sr-only">Search customers</label>
<input type="text" id="customerSearch" placeholder="Search customers..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<button id="customerSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200" aria-label="Search customers">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6" aria-hidden="true">
<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
</svg>
</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="customerList" class="bg-white divide-y divide-gray-200">
<!-- Customer list will be rendered here -->
<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No customers added yet</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Reports View -->
<div id="reportsView" class="view hidden" aria-labelledby="reports-heading">
<h2 id="reports-heading" class="text-3xl font-bold text-gray-900 mb-6">Reports</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Generate Report</h3>
<form id="reportForm" class="space-y-4">
<div class="flex flex-col">
<label for="reportType" class="text-sm font-medium text-gray-700 mb-1">Report Type</label>
<select id="reportType" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<option value="sales">Sales Report</option>
<option value="inventory">Inventory Report</option>
<option value="profit">Profit Report</option>
<option value="expenses">Expenses Report</option>
</select>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="flex flex-col">
<label for="startDate" class="text-sm font-medium text-gray-700 mb-1">Start Date</label>
<input type="date" id="startDate" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="endDate" class="text-sm font-medium text-gray-700 mb-1">End Date</label>
<input type="date" id="endDate" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
</div>
<div class="flex space-x-4">
<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Generate Report</button>
<button type="button" id="exportReportButton" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Export to Excel</button>
</div>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Stats</h3>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span class="text-gray-600">Today's Sales</span>
<span class="font-semibold" id="todaySales">0 MMK</span>
</div>
<div class="flex justify-between items-center">
<span class="text-gray-600">This Month's Sales</span>
<span class="font-semibold" id="monthSales">0 MMK</span>
</div>
<div class="flex justify-between items-center">
<span class="text-gray-600">This Month's Profit</span>
<span class="font-semibold" id="monthProfit">0 MMK</span>
</div>
<div class="flex justify-between items-center">
<span class="text-gray-600">Low Stock Items</span>
<span class="font-semibold" id="lowStockCount">0</span>
</div>
</div>
</div>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Report Results</h3>
<div id="reportResults" class="overflow-x-auto">
<!-- Report results will be rendered here -->
<p class="text-center text-gray-500">Generate a report to see results</p>
</div>
</div>
</div>

<!-- Settings View -->
<div id="settingsView" class="view hidden" aria-labelledby="settings-heading">
<h2 id="settings-heading" class="text-3xl font-bold text-gray-900 mb-6">Settings</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Company Information</h3>
<form id="companyForm" class="space-y-4">
<div class="flex flex-col">
<label for="companyName" class="text-sm font-medium text-gray-700 mb-1">Company Name</label>
<input type="text" id="companyName" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" value="Swift POS">
</div>
<div class="flex flex-col">
<label for="companyLogo" class="text-sm font-medium text-gray-700 mb-1">Company Logo</label>
<input type="file" id="companyLogo" accept="image/*" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex flex-col">
<label for="companyAddress" class="text-sm font-medium text-gray-700 mb-1">Address</label>
<textarea id="companyAddress" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
</div>
<div class="flex flex-col">
<label for="companyPhone" class="text-sm font-medium text-gray-700 mb-1">Phone Number</label>
<input type="tel" id="companyPhone" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Company Info</button>
</form>
</div>
<div class="bg-white rounded-lg p-6 shadow-md">
<h3 class="text-xl font-semibold text-gray-800 mb-4">System Settings</h3>
<form id="systemForm" class="space-y-4">
<div class="flex flex-col">
<label for="language" class="text-sm font-medium text-gray-700 mb-1">Language</label>
<select id="language" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-800">
<option value="en">English</option>
<option value="my">Burmese ()</option>
</select>
</div>
<div class="flex flex-col">
<label for="currency" class="text-sm font-medium text-gray-700 mb-1">Currency</label>
<select id="currency" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
<option value="MMK">Myanmar Kyat (MMK)</option>
<option value="USD">US Dollar (USD)</option>
<option value="EUR">Euro (EUR)</option>
</select>
</div>
<div class="flex flex-col">
<label for="taxRate" class="text-sm font-medium text-gray-700 mb-1">Tax Rate (%)</label>
<input type="number" id="taxRate" min="0" max="100" value="0" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
</div>
<div class="flex items-center">
<input type="checkbox" id="enableNotifications" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
<label for="enableNotifications" class="ml-2 text-sm font-medium text-gray-700">Enable Notifications</label>
</div>
<div class="flex items-center">
<input type="checkbox" id="enableSound" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
<label for="enableSound" class="ml-2 text-sm font-medium text-gray-700">Enable Sound Effects</label>
</div>
<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save System Settings</button>
</form>
</div>
</div>
<div class="bg-white rounded-lg p-6 shadow-md mt-6">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Data Management</h3>
		<div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
<button id="exportDataButton" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Export Data</button>
<button id="importDataButton" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">Import Data</button>
<button id="resetDataButton" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200">Reset Data</button>
</div>
</div>

	<div class="bg-white rounded-lg p-6 shadow-md mt-6">
		<h3 class="text-xl font-semibold text-gray-800 mb-4">Storage Preferences</h3>
		<form id="storageForm" class="space-y-4">
			<div class="flex items-center gap-6">
				<label class="flex items-center gap-2">
					<input type="radio" name="storageType" value="local" class="text-indigo-600" checked>
					<span>Local Folder</span>
				</label>
				<label class="flex items-center gap-2">
					<input type="radio" name="storageType" value="online" class="text-indigo-600">
					<span>Online Folder (URL)</span>
				</label>
			</div>
			<div class="flex flex-col md:flex-row md:items-center gap-2">
				<label for="storagePath" class="text-sm font-medium text-gray-700 mb-1 md:mb-0">Path or URL</label>
				<input type="text" id="storagePath" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/Users/me/Documents or https://drive.google.com/...">
				<button type="button" id="pickLocalFolderButton" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Choose Folder</button>
			</div>
			<button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Storage Preference</button>
		</form>
	</div>
</div>
</main>

<!-- Footer -->
<footer class="w-full bg-gray-800 text-white py-4 text-center">
<p>&copy; 2023 Swift POS. All rights reserved.</p>
</footer>

<!-- PWA Install Button -->
<div id="installContainer" class="fixed bottom-4 right-4 z-50">
    <button id="installButton" class="hidden bg-blue-900 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-blue-800 transition-transform transform hover:scale-105">
        Install App
    </button>
</div>

<!-- Toast Notifications -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
/**
 * @file Main application logic for the Swift POS system.
 * This file handles UI interactions, data management, and business logic.
 * @author Jules
 */

// ===========================
// APP INITIALIZATION
// ===========================

/**
 * An object containing references to all the main view elements in the DOM.
 * @type {Object<string, HTMLElement>}
 */
const views = {
    dashboard: document.getElementById('dashboardView'),
    products: document.getElementById('productsView'),
    sales: document.getElementById('salesView'),
    suppliers: document.getElementById('suppliersView'),
    expenses: document.getElementById('expensesView'),
    customers: document.getElementById('customersView'),
    reports: document.getElementById('reportsView'),
    settings: document.getElementById('settingsView')
};

/**
 * An object containing references to all the main tab button elements.
 * @type {Object<string, HTMLElement>}
 */
const tabButtons = {
    dashboard: document.getElementById('dashboardTab'),
    products: document.getElementById('productsTab'),
    sales: document.getElementById('salesTab'),
    suppliers: document.getElementById('suppliersTab'),
    expenses: document.getElementById('expensesTab'),
    customers: document.getElementById('customersTab'),
    reports: document.getElementById('reportsTab'),
    settings: document.getElementById('settingsTab')
};

// Mobile navigation elements
const mobileNavSelect = document.getElementById('mobileNavSelect');
const mobileMenuButton = document.getElementById('mobileMenuButton');
const closeSidebar = document.getElementById('closeSidebar');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

/**
 * Chart.js chart instances.
 * @type {Chart}
 */
let salesChart, monthlyProfitChart, bestSellingProductsChart, salesByCategoryChart, monthlyFinancialsChart, monthlyExpensesByCategoryChart;

// ===========================
// DATA MANAGEMENT
// ===========================

/**
 * Initializes the local storage with default empty arrays for data if they don't exist.
 */
function initializeData() {
    if (!localStorage.getItem('products')) localStorage.setItem('products', JSON.stringify([]));
    if (!localStorage.getItem('sales')) localStorage.setItem('sales', JSON.stringify([]));
    if (!localStorage.getItem('suppliers')) localStorage.setItem('suppliers', JSON.stringify([]));
    if (!localStorage.getItem('expenses')) localStorage.setItem('expenses', JSON.stringify([]));
    if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify([]));
    if (!localStorage.getItem('companyInfo')) localStorage.setItem('companyInfo', JSON.stringify({ name: 'Swift POS', logo: '', address: '', phone: '' }));
    if (!localStorage.getItem('systemSettings')) localStorage.setItem('systemSettings', JSON.stringify({ currency: 'MMK', taxRate: 0, enableNotifications: true, enableSound: true, storagePreference: { type: 'local', path: '' } }));
    if (!localStorage.getItem('categories')) localStorage.setItem('categories', JSON.stringify(['Tops', 'Dresses', 'Pants', 'Shoes', 'Accessories']));
}

/**
 * Retrieves products from local storage.
 * @returns {Array<Object>} An array of product objects.
 */
function getProducts() {
    return JSON.parse(localStorage.getItem('products')) || [];
}

/**
 * Retrieves sales from local storage.
 * @returns {Array<Object>} An array of sale objects.
 */
function getSales() {
    return JSON.parse(localStorage.getItem('sales')) || [];
}

/**
 * Retrieves suppliers from local storage.
 * @returns {Array<Object>} An array of supplier objects.
 */
function getSuppliers() {
    return JSON.parse(localStorage.getItem('suppliers')) || [];
}

/**
 * Retrieves expenses from local storage.
 * @returns {Array<Object>} An array of expense objects.
 */
function getExpenses() {
    return JSON.parse(localStorage.getItem('expenses')) || [];
}

/**
 * Retrieves customers from local storage.
 * @returns {Array<Object>} An array of customer objects.
 */
function getCustomers() {
    return JSON.parse(localStorage.getItem('customers')) || [];
}

/**
 * Retrieves company information from local storage.
 * @returns {Object} The company information object.
 */
function getCompanyInfo() {
    return JSON.parse(localStorage.getItem('companyInfo')) || {};
}

/**
 * Retrieves system settings from local storage.
 * @returns {Object} The system settings object.
 */
function getSystemSettings() {
    return JSON.parse(localStorage.getItem('systemSettings')) || {};
}

/**
 * Retrieves product categories from local storage.
 * @returns {Array<string>} An array of category names.
 */
function getCategories() {
    return JSON.parse(localStorage.getItem('categories')) || [];
}

/**
 * Saves an array of products to local storage.
 * @param {Array<Object>} products The array of products to save.
 */
function saveProducts(products) {
    localStorage.setItem('products', JSON.stringify(products));
}

/**
 * Saves an array of sales to local storage.
 * @param {Array<Object>} sales The array of sales to save.
 */
function saveSales(sales) {
    localStorage.setItem('sales', JSON.stringify(sales));
}

/**
 * Saves an array of suppliers to local storage.
 * @param {Array<Object>} suppliers The array of suppliers to save.
 */
function saveSuppliers(suppliers) {
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
}

/**
 * Saves an array of expenses to local storage.
 * @param {Array<Object>} expenses The array of expenses to save.
 */
function saveExpenses(expenses) {
    localStorage.setItem('expenses', JSON.stringify(expenses));
}

/**
 * Saves an array of customers to local storage.
 * @param {Array<Object>} customers The array of customers to save.
 */
function saveCustomers(customers) {
    localStorage.setItem('customers', JSON.stringify(customers));
}

/**
 * Saves the company information object to local storage.
 * @param {Object} info The company information object to save.
 */
function saveCompanyInfo(info) {
    localStorage.setItem('companyInfo', JSON.stringify(info));
}

/**
 * Saves the system settings object to local storage.
 * @param {Object} settings The system settings object to save.
 */
function saveSystemSettings(settings) {
    localStorage.setItem('systemSettings', JSON.stringify(settings));
}

/**
 * Saves the product categories array to local storage.
 * @param {Array<string>} categories The array of category names to save.
 */
function saveCategories(categories) {
    localStorage.setItem('categories', JSON.stringify(categories));
}

// ===========================
// UTILITY FUNCTIONS
// ===========================

/**
 * Formats a number as a currency string based on system settings.
 * @param {number} amount The number to format.
 * @returns {string} The formatted currency string.
 */
function formatCurrency(amount) {
    const settings = getSystemSettings();
    const currency = settings.currency || 'MMK';
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
    return formatter.format(amount);
}

/**
 * Displays a toast notification message.
 * @param {string} message The message to display.
 * @param {('info'|'success'|'error'|'warning')} [type='info'] The type of toast notification.
 */
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `p-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
    } transform transition-all duration-300 ease-in-out translate-x-full`;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 10);

    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            toastContainer.removeChild(toast);
        }, 300);
    }, 3000);
}

/**
 * Generates a simple unique ID.
 * @returns {string} A unique ID string.
 */
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

/**
 * Validates an email address format.
 * @param {string} email The email to validate.
 * @returns {boolean} True if the email format is valid, false otherwise.
 */
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

/**
 * Validates a phone number format.
 * @param {string} phone The phone number to validate.
 * @returns {boolean} True if the phone number format is valid, false otherwise.
 */
function isValidPhone(phone) {
    const phoneRegex = /^\+?[\d\s-()]{10,}$/;
    return phoneRegex.test(phone);
}

// ===========================
// VIEW MANAGEMENT
// ===========================

/**
 * Shows a specific view and hides all others. Also triggers data loading for the view.
 * @param {string} viewName The name of the view to show (e.g., 'dashboard', 'products').
 */
function showView(viewName) {
    Object.values(views).forEach(view => view.classList.add('hidden'));
    views[viewName].classList.remove('hidden');

    Object.values(tabButtons).forEach(button => button.classList.remove('active-tab'));
    tabButtons[viewName].classList.add('active-tab');

    mobileNavSelect.value = viewName;
    sidebar.classList.remove('open');
    overlay.classList.remove('open');

    switch (viewName) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'products':
            loadProducts();
            loadSuppliersForProducts();
            attachCategoryAddHandler();
            break;
        case 'sales':
            loadProductsForSales();
            loadCustomersForSales();
            break;
        case 'suppliers':
            loadSuppliers();
            initializeSupplierPaymentsUI();
            break;
        case 'expenses':
            loadExpenses();
            break;
        case 'customers':
            loadCustomers();
            break;
        case 'reports':
            loadReports();
            break;
        case 'settings':
            loadSettings();
            break;
    }
}

// ===========================
// DASHBOARD FUNCTIONALITY
// ===========================

/**
 * Loads all data and updates the dashboard view.
 */
function loadDashboardData() {
    const sales = getSales();
    const products = getProducts();
    const expenses = getExpenses();
    const companyInfo = getCompanyInfo();


    const now = new Date();
    document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
    const totalProfit = sales.reduce((sum, sale) => sum + sale.profit, 0);
    const totalProducts = products.length;
    const totalCreditPayments = expenses.filter(expense => expense.category === 'Credit Payment').reduce((sum, expense) => sum + expense.amount, 0);

    document.getElementById('totalSales').textContent = formatCurrency(totalSales);
    document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('totalCreditPayments').textContent = formatCurrency(totalCreditPayments);

    updateCharts(sales, products, expenses);
    updateAnalytics(sales, products);
    updateSupplierPayments(expenses);
}

/**
 * Updates all charts on the dashboard.
 * @param {Array<Object>} sales - Array of sale objects.
 * @param {Array<Object>} products - Array of product objects.
 * @param {Array<Object>} expenses - Array of expense objects.
 */
function updateCharts(sales, products, expenses) {
    const currentYear = new Date().getFullYear();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const getMonthlyTotals = (data, dateField, valueField) => {
        return months.map((_, index) => {
            const monthData = data.filter(item => {
                const itemDate = new Date(item[dateField]);
                return itemDate.getFullYear() === currentYear && itemDate.getMonth() === index;
            });
            return monthData.reduce((sum, item) => sum + (item[valueField] || 0), 0);
        });
    };

    const getMonthlyCategoryTotals = (data, dateField, valueField, categoryField) => {
        const categoryTotals = {};
        data.forEach(item => {
            const itemDate = new Date(item[dateField]);
            if (itemDate.getFullYear() === currentYear) {
                const category = item[categoryField] || 'Uncategorized';
                if (!categoryTotals[category]) {
                    categoryTotals[category] = Array(12).fill(0);
                }
                categoryTotals[category][itemDate.getMonth()] += item[valueField];
            }
        });
        return categoryTotals;
    };

    const monthlyRevenue = getMonthlyTotals(sales, 'date', 'total');
    const monthlyProfit = getMonthlyTotals(sales, 'date', 'profit');
    const monthlyExpenses = getMonthlyTotals(expenses, 'date', 'amount');

    const last7Days = Array.from({ length: 7 }, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toISOString().split('T')[0];
    }).reverse();

    const salesByDay = last7Days.map(date => {
        const daySales = sales.filter(sale => sale.date === date);
        return daySales.reduce((sum, sale) => sum + sale.total, 0);
    });

    const salesCtx = document.getElementById('salesChart').getContext('2d');
    if (salesChart) salesChart.destroy();
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Sales',
                data: salesByDay,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } }
        }
    });

    const profitCtx = document.getElementById('monthlyProfitChart').getContext('2d');
    if (monthlyProfitChart) monthlyProfitChart.destroy();
    monthlyProfitChart = new Chart(profitCtx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Profit',
                data: monthlyProfit,
                backgroundColor: '#10b981'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } }
        }
    });

    const productSales = {};
    sales.forEach(sale => sale.items.forEach(item => {
        productSales[item.productId] = (productSales[item.productId] || 0) + item.quantity;
    }));
    const topProducts = Object.entries(productSales)
        .map(([productId, quantity]) => ({ name: (products.find(p => p.id === productId) || { name: 'Unknown' }).name, quantity }))
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);

    const bestSellingCtx = document.getElementById('bestSellingProductsChart').getContext('2d');
    if (bestSellingProductsChart) bestSellingProductsChart.destroy();
    bestSellingProductsChart = new Chart(bestSellingCtx, {
        type: 'doughnut',
        data: {
            labels: topProducts.map(p => p.name),
            datasets: [{
                data: topProducts.map(p => p.quantity),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const categorySales = {};
    sales.forEach(sale => sale.items.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product) {
            categorySales[product.category] = (categorySales[product.category] || 0) + item.total;
        }
    }));
    const categoryCtx = document.getElementById('salesByCategoryChart').getContext('2d');
    if (salesByCategoryChart) salesByCategoryChart.destroy();
    salesByCategoryChart = new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(categorySales),
            datasets: [{
                data: Object.values(categorySales),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316']
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const profitPercentage = monthlyRevenue.map((rev, i) => rev > 0 ? (monthlyProfit[i] / rev) * 100 : 0);
    const expensePercentage = monthlyRevenue.map((rev, i) => rev > 0 ? (monthlyExpenses[i] / rev) * 100 : 0);

    const financialsCtx = document.getElementById('monthlyFinancialsChart').getContext('2d');
    if (monthlyFinancialsChart) monthlyFinancialsChart.destroy();
    monthlyFinancialsChart = new Chart(financialsCtx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Revenue',
                    data: monthlyRevenue,
                    backgroundColor: '#3b82f6',
                    yAxisID: 'yAmount',
                    order: 1
                },
                {
                    label: 'Profit %',
                    data: profitPercentage,
                    backgroundColor: '#22c55e',
                    yAxisID: 'yPercentage',
                    type: 'line',
                    order: 0
                },
                {
                    label: 'Expense %',
                    data: expensePercentage,
                    backgroundColor: '#ef4444',
                    borderColor: '#ef4444',
                    yAxisID: 'yPercentage',
                    type: 'line',
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
                yAmount: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Revenue' },
                    ticks: { callback: value => formatCurrency(value) }
                },
                yPercentage: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'Percentage' },
                    ticks: { callback: value => `${value}%` },
                    grid: { drawOnChartArea: false }
                }
            },
            plugins: { legend: { position: 'top' } }
        }
    });

    const monthlyExpensesByCategory = getMonthlyCategoryTotals(expenses, 'date', 'amount', 'category');
    const expenseCategoryCtx = document.getElementById('monthlyExpensesByCategoryChart').getContext('2d');
    if (monthlyExpensesByCategoryChart) monthlyExpensesByCategoryChart.destroy();
    monthlyExpensesByCategoryChart = new Chart(expenseCategoryCtx, {
        type: 'line',
        data: {
            labels: months,
            datasets: Object.entries(monthlyExpensesByCategory).map(([category, data], index) => {
                const colors = ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981'];
                return {
                    label: category,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    fill: false,
                    tension: 0.1
                };
            })
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } }
        }
    });
}

/**
 * Updates the additional analytics sections on the dashboard, including top selling,
 * low stock, and least selling items.
 * @param {Array<Object>} sales - The array of sale objects.
 * @param {Array<Object>} products - The array of product objects.
 */
function updateAnalytics(sales, products) {
    const productSales = {};
    sales.forEach(sale => {
        sale.items.forEach(item => {
            if (!productSales[item.productId]) {
                productSales[item.productId] = { quantity: 0, revenue: 0 };
            }
            productSales[item.productId].quantity += item.quantity;
            productSales[item.productId].revenue += item.total;
        });
    });

    const topSellingItems = Object.entries(productSales)
        .map(([productId, data]) => ({ name: (products.find(p => p.id === productId) || { name: 'Unknown' }).name, ...data }))
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 10);

    const topSellingContainer = document.getElementById('topSellingItems');
    if (topSellingItems.length > 0) {
        topSellingContainer.innerHTML = topSellingItems.map((item, index) => `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <span class="text-sm font-medium">${index + 1}. ${item.name}</span>
                <span class="text-xs text-gray-600">${item.quantity} sold</span>
            </div>`).join('');
    } else {
        topSellingContainer.innerHTML = '<p class="text-gray-500 text-center">No sales data available</p>';
    }

    const lowStockItems = products.filter(product => product.stock < 10)
        .sort((a, b) => a.stock - b.stock)
        .slice(0, 10);

    const lowStockContainer = document.getElementById('lowStockItems');
    if (lowStockItems.length > 0) {
        lowStockContainer.innerHTML = lowStockItems.map(item => `
            <div class="flex justify-between items-center p-2 bg-red-50 rounded">
                <span class="text-sm font-medium">${item.name}</span>
                <span class="text-xs text-red-600">${item.stock} left</span>
            </div>`).join('');
    } else {
        lowStockContainer.innerHTML = '<p class="text-gray-500 text-center">No low stock items</p>';
    }

    const leastSellingItems = Object.entries(productSales)
        .map(([productId, data]) => ({ name: (products.find(p => p.id === productId) || { name: 'Unknown' }).name, ...data }))
        .filter(item => item.quantity > 0)
        .sort((a, b) => a.quantity - b.quantity)
        .slice(0, 10);

    const leastSellingContainer = document.getElementById('leastSellingItems');
    if (leastSellingItems.length > 0) {
        leastSellingContainer.innerHTML = leastSellingItems.map((item, index) => `
            <div class="flex justify-between items-center p-2 bg-yellow-50 rounded">
                <span class="text-sm font-medium">${index + 1}. ${item.name}</span>
                <span class="text-xs text-yellow-600">${item.quantity} sold</span>
            </div>`).join('');
    } else {
        leastSellingContainer.innerHTML = '<p class="text-gray-500 text-center">No sales data available</p>';
    }
}

/**
 * Updates the recent supplier payments list on the dashboard, showing the last 5 payments.
 * @param {Array<Object>} expenses - The array of all expense objects.
 */
function updateSupplierPayments(expenses) {
    const supplierPayments = expenses
        .filter(expense => expense.category === 'Supplier Payment')
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

    const paymentsContainer = document.getElementById('supplierPaymentsDashboard');
    if (supplierPayments.length > 0) {
        paymentsContainer.innerHTML = supplierPayments.map(payment => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${payment.description || 'Supplier Payment'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(payment.date).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(payment.amount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.notes || ''}</td>
            </tr>`).join('');
    } else {
        paymentsContainer.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No recent payments</td></tr>';
    }
}

// ===========================
// PRODUCTS FUNCTIONALITY
// ===========================

/**
 * Loads products from storage, renders them in the product list table,
 * and attaches event listeners for edit and delete actions.
 */
function loadProducts() {
    const products = getProducts();
    const productList = document.getElementById('productList');
    populateProductCategorySelect();

    if (products.length === 0) {
        productList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No products added yet</td></tr>';
        return;
    }

    productList.innerHTML = products.map(product => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    ${product.image ? `<img src="${product.image}" alt="${product.name}" class="h-10 w-10 rounded-full object-cover mr-3">` : ''}
                    <div>
                        <div class="text-sm font-medium text-gray-900">${product.name}</div>
                        ${product.barcode ? `<div class="text-sm text-gray-500">Barcode: ${product.barcode}</div>` : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${product.stock < 10 ? 'text-red-600 font-semibold' : ''}">${product.stock}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.buyingPrice)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.sellingPrice)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<button class="text-blue-900 hover:text-blue-700 mr-3 edit-product" data-id="${product.id}">Edit</button>
<button class="text-red-600 hover:text-red-800 delete-product" data-id="${product.id}">Delete</button>
            </td>
        </tr>`).join('');

    document.querySelectorAll('.edit-product').forEach(button => button.addEventListener('click', function() { editProduct(this.getAttribute('data-id')); }));
    document.querySelectorAll('.delete-product').forEach(button => button.addEventListener('click', function() { deleteProduct(this.getAttribute('data-id')); }));
}

/**
 * Populates the supplier dropdown in the product form.
 */
function loadSuppliersForProducts() {
    const suppliers = getSuppliers();
    const supplierSelect = document.getElementById('productSupplier');
    supplierSelect.innerHTML = '<option value="">Select a supplier</option>' + suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

/**
 * Populates the product form with data from an existing product for editing.
 * @param {string} productId The ID of the product to edit.
 */
function editProduct(productId) {
    const product = getProducts().find(p => p.id === productId);
    if (product) {
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        populateProductCategorySelect();
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productStock').value = product.stock;
        document.getElementById('productBuyingPrice').value = product.buyingPrice;
        document.getElementById('productSellingPrice').value = product.sellingPrice;
        document.getElementById('productSize').value = product.size || '';
        document.getElementById('productColor').value = product.color || '';
        document.getElementById('productSupplier').value = product.supplierId || '';
        document.getElementById('productBarcode').value = product.barcode || '';
        document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
    }
}

/**
 * Deletes a product after confirmation.
 * @param {string} productId The ID of the product to delete.
 */
function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        saveProducts(getProducts().filter(p => p.id !== productId));
        loadProducts();
        showToast('Product deleted successfully', 'success');
    }
}

/**
 * Resets the product form to its default state.
 */
function resetProductForm() {
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    populateProductCategorySelect();
}

/**
 * Attaches an event handler to the 'Add Category' button.
 */
function attachCategoryAddHandler() {
    const addBtn = document.getElementById('addCategoryButton');
    const input = document.getElementById('newCategoryInput');
    if (!addBtn || !input) return;
    addBtn.onclick = function() {
        const newCat = (input.value || '').trim();
        if (!newCat) return showToast('Enter a category name', 'error');
        const categories = getCategories();
        if (categories.includes(newCat)) return showToast('Category already exists', 'warning');

        categories.push(newCat);
        saveCategories(categories);
        populateProductCategorySelect();
        document.getElementById('productCategory').value = newCat;
        populateSalesFilters();
        input.value = '';
        showToast('Category added', 'success');
    };
}

// ===========================
// SALES FUNCTIONALITY
// ===========================

let cart = [];

/**
 * Loads products and category filters for the sales view.
 */
function loadProductsForSales() {
    populateSalesFilters();
    applySalesFilters();
}

/**
 * Populates the category filter chips in the sales view.
 */
function populateSalesFilters() {
    const categories = getCategories();
    const chips = document.getElementById('salesCategoryChips');
    if (chips) {
        chips.innerHTML = categories.map(c => `<button type="button" class="px-3 py-1 rounded-full border text-sm sales-chip" data-cat="${c}">${c}</button>`).join('');
        chips.querySelectorAll('.sales-chip').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('bg-blue-900');
                this.classList.toggle('text-white');
                applySalesFilters();
            });
        });
    }
    const search = document.getElementById('salesSearch');
    if (search) {
        search.removeEventListener('input', applySalesFilters);
        search.addEventListener('input', applySalesFilters);
    }
}

/**
 * Populates the category select dropdown in the product form.
 */
function populateProductCategorySelect() {
    const categories = getCategories();
    const select = document.getElementById('productCategory');
    if (!select) return;
    const current = select.value;
    select.innerHTML = '<option value="">Select Category</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    if (current) select.value = current;
}

/**
 * Filters and displays products in the sales grid based on search and category filters.
 */
function applySalesFilters() {
    const allProducts = getProducts();
    const term = (document.getElementById('salesSearch').value || '').toLowerCase();
    const selectedCats = Array.from(document.querySelectorAll('#salesCategoryChips .sales-chip.bg-indigo-600')).map(b => b.getAttribute('data-cat'));
    const filtered = allProducts.filter(p =>
        (selectedCats.length === 0 || selectedCats.includes(p.category)) &&
        (p.name.toLowerCase().includes(term) || (p.barcode || '').toLowerCase().includes(term))
    );
    renderSalesProductGrid(filtered);
}

/**
 * Renders the product grid in the sales view.
 * @param {Array<Object>} products The products to render.
 */
function renderSalesProductGrid(products) {
    const grid = document.getElementById('salesProductGrid');
    if (!grid) return;
    if (!products || products.length === 0) {
        grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No products found</p>';
        return;
    }
    grid.innerHTML = products.map(p => `
        <button class="border rounded-lg p-3 text-left hover:shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 add-to-cart-card" data-id="${p.id}" ${p.stock <= 0 ? 'disabled' : ''}>
            ${p.image ? `<img src="${p.image}" alt="${p.name}" class="w-full h-28 object-cover rounded mb-2">` : ''}
            <div class="flex justify-between items-center">
                <span class="font-semibold truncate">${p.name}</span>
                <span class="text-sm text-gray-500">${formatCurrency(p.sellingPrice)}</span>
            </div>
            <div class="text-xs text-gray-600 mt-1">${p.category || 'Uncategorized'}</div>
            <div class="text-xs mt-1 ${p.stock <= 0 ? 'text-red-600 font-semibold' : 'text-gray-600'}">Stock left: ${p.stock}</div>
        </button>`).join('');
    grid.querySelectorAll('.add-to-cart-card').forEach(btn => {
        btn.addEventListener('click', function() { addProductCardToCart(this.getAttribute('data-id')); });
    });
}

/**
 * Adds a product to the cart when its card is clicked in the sales view.
 * @param {string} productId The ID of the product to add.
 */
function addProductCardToCart(productId) {
    const product = getProducts().find(p => p.id === productId);
    if (!product) return showToast('Product not found', 'error');
    if (product.stock < 1) return showToast(`Insufficient stock for ${product.name}`, 'error');

    const existingItem = cart.find(item => item.productId === productId);
    if (existingItem) {
        existingItem.quantity++;
        existingItem.total = calculateItemTotal(existingItem.price, existingItem.quantity, existingItem.discount);
    } else {
        const discount = parseFloat(document.getElementById('discountInput').value) || 0;
        cart.push({
            id: generateId(),
            productId,
            name: product.name,
            price: product.sellingPrice,
            quantity: 1,
            discount,
            total: calculateItemTotal(product.sellingPrice, 1, discount)
        });
    }
    updateCartDisplay();
    updateReceipt();
    showToast(`${product.name} added to cart`, 'success');
}

/**
 * Loads customers into the customer dropdown in the sales view.
 */
function loadCustomersForSales() {
    const customers = getCustomers();
    const customerSelect = document.getElementById('customerSelect');
    customerSelect.innerHTML = '<option value="walk-in">Walk-in Customer</option><option value="online">Online Customer</option>';
    customers.forEach(customer => {
        customerSelect.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
    });
}

/**
 * Calculates the total for a cart item, including discounts.
 * @param {number} price The item's base price.
 * @param {number} quantity The quantity of the item.
 * @param {number} discount The discount percentage.
 * @returns {number} The calculated total price.
 */
function calculateItemTotal(price, quantity, discount) {
    const discountedPrice = price * (1 - discount / 100);
    return discountedPrice * quantity;
}

/**
 * Updates the cart display table and totals.
 */
function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');

    if (cart.length === 0) {
        cartItems.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No items in cart</td></tr>';
        cartTotalEl.textContent = formatCurrency(0);
        return;
    }

    cartItems.innerHTML = cart.map(item => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.discount}%</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-cart-item" data-id="${item.id}">Edit</button>
                <button class="text-red-600 hover:text-red-900 remove-from-cart" data-id="${item.id}">Remove</button>
            </td>
        </tr>`).join('');

    let total = cart.reduce((sum, item) => sum + item.total, 0);
    const orderDiscount = Math.min(100, Math.max(0, parseFloat(document.getElementById('orderDiscount')?.value) || 0));
    total = total * (1 - orderDiscount / 100);

    cartTotalEl.textContent = formatCurrency(total);
    document.getElementById('amountPaid').value = Math.round(total);

    document.querySelectorAll('.remove-from-cart').forEach(button => button.addEventListener('click', function() { removeFromCart(this.getAttribute('data-id')); }));
    document.querySelectorAll('.edit-cart-item').forEach(button => button.addEventListener('click', function() { editCartItem(this.getAttribute('data-id')); }));
}

/**
 * Removes an item from the cart.
 * @param {string} itemId The ID of the cart item to remove.
 */
function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    updateCartDisplay();
    updateReceipt();
    showToast('Item removed from cart', 'success');
}

/**
 * Edits the quantity and discount of a cart item.
 * @param {string} itemId The ID of the cart item to edit.
 */
function editCartItem(itemId) {
    const item = cart.find(i => i.id === itemId);
    if (!item) return;

    const newQty = parseInt(prompt('Enter new quantity:', String(item.quantity)));
    if (!isFinite(newQty) || newQty <= 0) return showToast('Invalid quantity', 'error');

    const newDiscount = parseFloat(prompt('Enter new discount (%):', String(item.discount)));
    if (!isFinite(newDiscount) || newDiscount < 0 || newDiscount > 100) return showToast('Invalid discount', 'error');

    const product = getProducts().find(p => p.id === item.productId);
    if (product && product.stock < newQty) return showToast(`Insufficient stock. Only ${product.stock} available`, 'error');

    item.quantity = newQty;
    item.discount = newDiscount;
    item.total = calculateItemTotal(item.price, newQty, newDiscount);
    updateCartDisplay();
    updateReceipt();
    showToast('Item updated', 'success');
}

/**
 * Clears all items from the cart.
 */
function clearCart() {
    if (cart.length === 0) return showToast('Cart is already empty', 'info');
    if (confirm('Are you sure you want to clear the cart?')) {
        cart = [];
        updateCartDisplay();
        updateReceipt();
        showToast('Cart cleared', 'success');
    }
}

/**
 * Updates the receipt display based on the current cart state.
 */
function updateReceipt() {
    const receiptItems = document.getElementById('receiptItems');
    const receiptTotal = document.getElementById('receiptTotal');
    const receiptPaid = document.getElementById('receiptPaid');
    const receiptChange = document.getElementById('receiptChange');
    const receiptDate = document.getElementById('receiptDate');

    if (cart.length === 0) {
        receiptItems.innerHTML = '<p class="text-center text-gray-500">No items</p>';
        receiptTotal.textContent = formatCurrency(0);
        receiptPaid.textContent = formatCurrency(0);
        receiptChange.textContent = formatCurrency(0);
    } else {
        receiptItems.innerHTML = cart.map(item => `
            <div class="flex justify-between text-sm">
                <span>${item.name} x${item.quantity}</span>
                <span>${formatCurrency(item.total)}</span>
            </div>`).join('');

        let total = cart.reduce((sum, item) => sum + item.total, 0);
        const orderDiscount = Math.min(100, Math.max(0, parseFloat(document.getElementById('orderDiscount')?.value) || 0));
        total = total * (1 - orderDiscount / 100);

        const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
        receiptTotal.textContent = formatCurrency(total);
        receiptPaid.textContent = formatCurrency(amountPaid);
        receiptChange.textContent = formatCurrency(Math.max(0, amountPaid - total));
    }
    receiptDate.textContent = new Date().toLocaleString();
}

/**
 * Finalizes the sale, updates stock, and saves the sale record.
 */
function completeSale() {
    if (cart.length === 0) return showToast('Cart is empty', 'error');

    let total = cart.reduce((sum, item) => sum + item.total, 0);
    const orderDiscount = Math.min(100, Math.max(0, parseFloat(document.getElementById('orderDiscount')?.value) || 0));
    const finalTotal = total * (1 - orderDiscount / 100);

    const amountPaid = parseFloat(document.getElementById('amountPaid').value);
    if (isNaN(amountPaid) || amountPaid < finalTotal) return showToast(`Amount paid must be at least ${formatCurrency(finalTotal)}`, 'error');

    const products = getProducts();
    cart.forEach(item => {
        const productIndex = products.findIndex(p => p.id === item.productId);
        if (productIndex !== -1) {
            products[productIndex].stock -= item.quantity;
        }
    });
    saveProducts(products);

    const sale = {
        id: generateId(),
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString(),
        customerType: document.getElementById('customerSelect').value,
        paymentMethod: document.getElementById('paymentMethod').value,
        items: [...cart],
        total: finalTotal,
        profit: cart.reduce((sum, item) => {
            const product = products.find(p => p.id === item.productId);
            return sum + (item.total - (product ? product.buyingPrice * item.quantity : 0));
        }, 0),
        amountPaid,
        orderDiscount,
        change: amountPaid - finalTotal,
        notes: document.getElementById('saleNotes').value.trim()
    };

    saveSales([...getSales(), sale]);
    showToast('Sale completed successfully', 'success');

    cart = [];
    updateCartDisplay();
    updateReceipt();
    document.getElementById('saleNotes').value = '';

    if (!views.dashboard.classList.contains('hidden')) {
        loadDashboardData();
    }
}

/**
 * Opens a print dialog for the current receipt.
 */
function printReceipt() {
    if (cart.length === 0) return showToast('No items to print', 'error');
    const receiptContent = document.getElementById('receiptContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html><head><title>Receipt</title>
        <style>
            body { font-family: 'Courier New', Courier, monospace; margin: 0; padding: 10px; }
            .receipt { max-width: 300px; margin: 0 auto; }
            .text-center { text-align: center; }
            .border-t, .border-b { border-top: 1px dashed #000; }
            .border-b { border-bottom: 1px dashed #000; }
            .py-2 { padding: 5px 0; }
            .mb-4 { margin-bottom: 10px; }
            .flex { display: flex; }
            .justify-between { justify-content: space-between; }
            .font-semibold { font-weight: bold; }
            .text-sm { font-size: 12px; }
        </style>
        </head><body>${receiptContent}</body></html>`);
    printWindow.document.close();
    printWindow.print();
}

// ===========================
// SUPPLIERS FUNCTIONALITY
// ===========================

/**
 * Loads and displays the list of suppliers.
 */
function loadSuppliers() {
    const suppliers = getSuppliers();
    const supplierList = document.getElementById('supplierList');

    if (suppliers.length === 0) {
        supplierList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No suppliers added yet</td></tr>';
        return;
    }

    supplierList.innerHTML = suppliers.map(supplier => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${supplier.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${supplier.phone || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${supplier.email || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${supplier.address || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-supplier" data-id="${supplier.id}">Edit</button>
                <button class="text-red-600 hover:text-red-900 delete-supplier" data-id="${supplier.id}">Delete</button>
            </td>
        </tr>`).join('');

    document.querySelectorAll('.edit-supplier').forEach(button => button.addEventListener('click', function() { editSupplier(this.getAttribute('data-id')); }));
    document.querySelectorAll('.delete-supplier').forEach(button => button.addEventListener('click', function() { deleteSupplier(this.getAttribute('data-id')); }));
}

/**
 * Initializes the UI elements for supplier payments.
 */
function initializeSupplierPaymentsUI() {
    populateSupplierPaymentSelect();
    const dateInput = document.getElementById('supplierPaymentDate');
    if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];

    const select = document.getElementById('supplierPaymentSelect');
    if (select) {
        select.removeEventListener('change', onSupplierPaymentSelectChange);
        select.addEventListener('change', onSupplierPaymentSelectChange);
        if (select.value) {
            updateSupplierPaymentSummary(select.value);
            renderSupplierPaymentHistory(select.value);
        }
    }

    const addBtn = document.getElementById('addSupplierPaymentBtn');
    if (addBtn) {
        addBtn.removeEventListener('click', onAddSupplierPayment);
        addBtn.addEventListener('click', onAddSupplierPayment);
    }
}

/**
 * Populates the supplier dropdown for payment tracking.
 */
function populateSupplierPaymentSelect() {
    const suppliers = getSuppliers();
    const select = document.getElementById('supplierPaymentSelect');
    if (!select) return;
    const current = select.value;
    select.innerHTML = '<option value="">Select a supplier</option>' + suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    if (current) select.value = current;
}

/**
 * Handles the change event for the supplier payment dropdown.
 * @param {Event} e The change event object.
 */
function onSupplierPaymentSelectChange(e) {
    const supplierId = e.target.value;
    updateSupplierPaymentSummary(supplierId);
    renderSupplierPaymentHistory(supplierId);
}

/**
 * Updates the summary of payments for a selected supplier.
 * @param {string} supplierId The ID of the selected supplier.
 */
function updateSupplierPaymentSummary(supplierId) {
    const totalPiecesEl = document.getElementById('supplierTotalPieces');
    const totalBuyingEl = document.getElementById('supplierTotalBuying');
    const totalPaidEl = document.getElementById('supplierTotalPaid');
    const remainingEl = document.getElementById('supplierTotalRemaining');

    if (!supplierId) {
        if (totalPiecesEl) totalPiecesEl.textContent = '0';
        if (totalBuyingEl) totalBuyingEl.textContent = formatCurrency(0);
        if (totalPaidEl) totalPaidEl.textContent = formatCurrency(0);
        if (remainingEl) remainingEl.textContent = formatCurrency(0);
        return;
    }

    const products = getProducts().filter(p => p.supplierId === supplierId);
    const payments = getExpenses().filter(e => e.category === 'Supplier Payment' && e.supplierId === supplierId);

    const totalPieces = products.reduce((sum, p) => sum + (parseInt(p.stock, 10) || 0), 0);
    const totalBuying = products.reduce((sum, p) => sum + ((parseFloat(p.buyingPrice) || 0) * (parseInt(p.stock, 10) || 0)), 0);
    const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);

    if (totalPiecesEl) totalPiecesEl.textContent = String(totalPieces);
    if (totalBuyingEl) totalBuyingEl.textContent = formatCurrency(totalBuying);
    if (totalPaidEl) totalPaidEl.textContent = formatCurrency(totalPaid);
    if (remainingEl) remainingEl.textContent = formatCurrency(Math.max(0, totalBuying - totalPaid));
}

/**
 * Renders the payment history for a selected supplier.
 * @param {string} supplierId The ID of the selected supplier.
 */
function renderSupplierPaymentHistory(supplierId) {
    const tbody = document.getElementById('supplierPaymentHistoryBody');
    if (!tbody) return;
    if (!supplierId) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Select a supplier</td></tr>';
        return;
    }
    const payments = getExpenses()
        .filter(e => e.category === 'Supplier Payment' && e.supplierId === supplierId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No payments recorded</td></tr>';
        return;
    }
    tbody.innerHTML = payments.map(p => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(p.date).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(p.amount)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.description || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-red-600 hover:text-red-900 delete-supplier-payment" data-id="${p.id}" data-supplier="${supplierId}">Delete</button>
            </td>
        </tr>`).join('');

    tbody.querySelectorAll('.delete-supplier-payment').forEach(btn => btn.addEventListener('click', function() {
        deleteSupplierPayment(this.getAttribute('data-id'), this.getAttribute('data-supplier'));
    }));
}

/**
 * Handles the click event for adding a supplier payment.
 * @param {Event} e The click event object.
 */
function onAddSupplierPayment(e) {
    e.preventDefault();
    const supplierId = document.getElementById('supplierPaymentSelect').value;
    const amount = parseFloat(document.getElementById('supplierPaymentAmount').value);
    const date = document.getElementById('supplierPaymentDate').value;
    const notes = document.getElementById('supplierPaymentNotes').value.trim();

    if (!supplierId) return showToast('Please select a supplier', 'error');
    if (isNaN(amount) || amount <= 0 || !date) return showToast('Enter a valid amount and date', 'error');

    const newPayment = {
        id: generateId(),
        category: 'Supplier Payment',
        amount,
        date,
        description: notes || null,
        supplierId
    };
    saveExpenses([...getExpenses(), newPayment]);
    showToast('Supplier payment recorded', 'success');

    document.getElementById('supplierPaymentAmount').value = '';
    document.getElementById('supplierPaymentNotes').value = '';
    updateSupplierPaymentSummary(supplierId);
    renderSupplierPaymentHistory(supplierId);
}

/**
 * Deletes a supplier payment record.
 * @param {string} expenseId The ID of the expense record to delete.
 * @param {string} supplierId The ID of the supplier to update the view for.
 */
function deleteSupplierPayment(expenseId, supplierId) {
    if (!confirm('Delete this payment? This cannot be undone.')) return;
    saveExpenses(getExpenses().filter(e => e.id !== expenseId));
    showToast('Payment deleted', 'success');
    updateSupplierPaymentSummary(supplierId);
    renderSupplierPaymentHistory(supplierId);
}

/**
 * Populates the supplier form for editing.
 * @param {string} supplierId The ID of the supplier to edit.
 */
function editSupplier(supplierId) {
    const supplier = getSuppliers().find(s => s.id === supplierId);
    if (supplier) {
        document.getElementById('supplierId').value = supplier.id;
        document.getElementById('supplierName').value = supplier.name;
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierEmail').value = supplier.email || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('supplierForm').scrollIntoView({ behavior: 'smooth' });
    }
}

/**
 * Deletes a supplier after confirmation.
 * @param {string} supplierId The ID of the supplier to delete.
 */
function deleteSupplier(supplierId) {
    if (confirm('Are you sure you want to delete this supplier?')) {
        saveSuppliers(getSuppliers().filter(s => s.id !== supplierId));
        loadSuppliers();
        showToast('Supplier deleted successfully', 'success');
    }
}

/**
 * Resets the supplier form.
 */
function resetSupplierForm() {
    document.getElementById('supplierForm').reset();
    document.getElementById('supplierId').value = '';
}

// ===========================
// EXPENSES FUNCTIONALITY
// ===========================

/**
 * Loads and displays the list of expenses.
 */
function loadExpenses() {
    const expenses = getExpenses();
    const expenseList = document.getElementById('expenseList');

    if (expenses.length === 0) {
        expenseList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No expenses added yet</td></tr>';
        return;
    }

    expenseList.innerHTML = expenses.map(expense => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${expense.category}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(expense.amount)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(expense.date).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.description || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-expense" data-id="${expense.id}">Edit</button>
                <button class="text-red-600 hover:text-red-900 delete-expense" data-id="${expense.id}">Delete</button>
            </td>
        </tr>`).join('');

    document.querySelectorAll('.edit-expense').forEach(button => button.addEventListener('click', function() { editExpense(this.getAttribute('data-id')); }));
    document.querySelectorAll('.delete-expense').forEach(button => button.addEventListener('click', function() { deleteExpense(this.getAttribute('data-id')); }));
}

/**
 * Populates the expense form for editing.
 * @param {string} expenseId The ID of the expense to edit.
 */
function editExpense(expenseId) {
    const expense = getExpenses().find(e => e.id === expenseId);
    if (expense) {
        document.getElementById('expenseId').value = expense.id;
        document.getElementById('expenseCategory').value = expense.category;
        document.getElementById('expenseAmount').value = expense.amount;
        document.getElementById('expenseDate').value = expense.date;
        document.getElementById('expenseDescription').value = expense.description || '';
        document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
    }
}

/**
 * Deletes an expense after confirmation.
 * @param {string} expenseId The ID of the expense to delete.
 */
function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense?')) {
        saveExpenses(getExpenses().filter(e => e.id !== expenseId));
        loadExpenses();
        showToast('Expense deleted successfully', 'success');
    }
}

/**
 * Resets the expense form.
 */
function resetExpenseForm() {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseId').value = '';
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
}

// ===========================
// CUSTOMERS FUNCTIONALITY
// ===========================

/**
 * Loads and displays the list of customers.
 */
function loadCustomers() {
    const customers = getCustomers();
    const customerList = document.getElementById('customerList');

    if (customers.length === 0) {
        customerList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No customers added yet</td></tr>';
        return;
    }

    customerList.innerHTML = customers.map(customer => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.phone || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.email || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.address || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-customer" data-id="${customer.id}">Edit</button>
                <button class="text-red-600 hover:text-red-900 delete-customer" data-id="${customer.id}">Delete</button>
            </td>
        </tr>`).join('');

    document.querySelectorAll('.edit-customer').forEach(button => button.addEventListener('click', function() { editCustomer(this.getAttribute('data-id')); }));
    document.querySelectorAll('.delete-customer').forEach(button => button.addEventListener('click', function() { deleteCustomer(this.getAttribute('data-id')); }));
}

/**
 * Populates the customer form for editing.
 * @param {string} customerId The ID of the customer to edit.
 */
function editCustomer(customerId) {
    const customer = getCustomers().find(c => c.id === customerId);
    if (customer) {
        document.getElementById('customerId').value = customer.id;
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone || '';
        document.getElementById('customerEmail').value = customer.email || '';
        document.getElementById('customerAddress').value = customer.address || '';
        document.getElementById('customerForm').scrollIntoView({ behavior: 'smooth' });
    }
}

/**
 * Deletes a customer after confirmation.
 * @param {string} customerId The ID of the customer to delete.
 */
function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer?')) {
        saveCustomers(getCustomers().filter(c => c.id !== customerId));
        loadCustomers();
        showToast('Customer deleted successfully', 'success');
    }
}

/**
 * Resets the customer form.
 */
function resetCustomerForm() {
    document.getElementById('customerForm').reset();
    document.getElementById('customerId').value = '';
}

// ===========================
// REPORTS FUNCTIONALITY
// ===========================

/**
 * Loads and displays quick stats for the reports view.
 */
function loadReports() {
    const sales = getSales();
    const products = getProducts();
    const today = new Date().toISOString().split('T')[0];
    const todaySales = sales.filter(s => s.date === today).reduce((sum, s) => sum + s.total, 0);
    document.getElementById('todaySales').textContent = formatCurrency(todaySales);

    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthSales = sales.filter(s => {
        const saleDate = new Date(s.date);
        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
    }).reduce((sum, s) => sum + s.total, 0);
    document.getElementById('monthSales').textContent = formatCurrency(monthSales);

    const monthProfit = sales.filter(s => {
        const saleDate = new Date(s.date);
        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
    }).reduce((sum, s) => sum + s.profit, 0);
    document.getElementById('monthProfit').textContent = formatCurrency(monthProfit);

    const lowStockCount = products.filter(p => p.stock < 10).length;
    document.getElementById('lowStockCount').textContent = lowStockCount;
}

/**
 * Generates a report based on the selected type and date range.
 * @param {string} type The type of report to generate.
 * @param {string} startDate The start date for the report.
 * @param {string} endDate The end date for the report.
 */
function generateReport(type, startDate, endDate) {
    const sales = getSales().filter(s => s.date >= startDate && s.date <= endDate);
    const products = getProducts();
    const expenses = getExpenses().filter(e => e.date >= startDate && e.date <= endDate);

    let reportHTML = '';
    switch (type) {
        case 'sales':
            reportHTML = generateSalesReport(sales, products);
            break;
        case 'inventory':
            reportHTML = generateInventoryReport(products);
            break;
        case 'profit':
            reportHTML = generateProfitReport(sales, products);
            break;
        case 'expenses':
            reportHTML = generateExpensesReport(expenses);
            break;
    }
    document.getElementById('reportResults').innerHTML = reportHTML;
}

/**
 * Generates the HTML for a sales report.
 * @param {Array<Object>} sales - The sales data for the report.
 * @param {Array<Object>} products - The product data for the report.
 * @returns {string} The HTML string for the report.
 */
function generateSalesReport(sales, products) {
    if (sales.length === 0) return '<p class="text-center text-gray-500">No sales data for the selected period</p>';

    const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
    const totalItems = sales.reduce((sum, sale) => sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

    let productSales = {};
    sales.forEach(sale => {
        sale.items.forEach(item => {
            if (!productSales[item.productId]) {
                productSales[item.productId] = { quantity: 0, revenue: 0 };
            }
            productSales[item.productId].quantity += item.quantity;
            productSales[item.productId].revenue += item.total;
        });
    });

    const productSalesArray = Object.entries(productSales)
        .map(([productId, data]) => ({ name: (products.find(p => p.id === productId) || { name: 'Unknown' }).name, ...data }))
        .sort((a, b) => b.revenue - a.revenue);

    return `
        <div class="mb-4">
            <h4 class="text-lg font-semibold">Sales Summary</h4>
            <p>Total Sales: <strong>${formatCurrency(totalSales)}</strong></p>
            <p>Total Items Sold: <strong>${totalItems}</strong></p>
            <p>Number of Transactions: <strong>${sales.length}</strong></p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity Sold</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${productSalesArray.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.revenue)}</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;
}

/**
 * Generates the HTML for an inventory report.
 * @param {Array<Object>} products - The product data for the report.
 * @returns {string} The HTML string for the report.
 */
function generateInventoryReport(products) {
    if (products.length === 0) return '<p class="text-center text-gray-500">No products in inventory</p>';

    const lowStockProducts = products.filter(p => p.stock < 10);
    const outOfStockProducts = products.filter(p => p.stock === 0);
    const totalValue = products.reduce((sum, product) => sum + (product.buyingPrice * product.stock), 0);

    return `
        <div class="mb-4">
            <h4 class="text-lg font-semibold">Inventory Summary</h4>
            <p>Total Products: <strong>${products.length}</strong></p>
            <p>Low Stock Items: <strong>${lowStockProducts.length}</strong></p>
            <p>Out of Stock Items: <strong>${outOfStockProducts.length}</strong></p>
            <p>Total Inventory Value: <strong>${formatCurrency(totalValue)}</strong></p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buying Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${products.map(product => `
                    <tr class="${product.stock === 0 ? 'bg-red-50' : product.stock < 10 ? 'bg-yellow-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${product.stock === 0 ? 'text-red-600 font-semibold' : product.stock < 10 ? 'text-yellow-600 font-semibold' : ''}">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.buyingPrice)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(product.buyingPrice * product.stock)}</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;
}

/**
 * Generates the HTML for a profit report.
 * @param {Array<Object>} sales - The sales data for the report.
 * @param {Array<Object>} products - The product data for the report.
 * @returns {string} The HTML string for the report.
 */
function generateProfitReport(sales, products) {
    if (sales.length === 0) return '<p class="text-center text-gray-500">No sales data for the selected period</p>';

    const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
    const totalCost = sales.reduce((sum, sale) => {
        const saleCost = sale.items.reduce((itemSum, item) => {
            const product = products.find(p => p.id === item.productId);
            return itemSum + (product ? product.buyingPrice * item.quantity : 0);
        }, 0);
        return sum + saleCost;
    }, 0);
    const totalProfit = totalRevenue - totalCost;
    const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

    return `
        <div class="mb-4">
            <h4 class="text-lg font-semibold">Profit Summary</h4>
            <p>Total Revenue: <strong>${formatCurrency(totalRevenue)}</strong></p>
            <p>Total Cost: <strong>${formatCurrency(totalCost)}</strong></p>
            <p>Total Profit: <strong>${formatCurrency(totalProfit)}</strong></p>
            <p>Profit Margin: <strong>${profitMargin.toFixed(2)}%</strong></p>
        </div>`;
}

/**
 * Generates the HTML for an expenses report.
 * @param {Array<Object>} expenses - The expense data for the report.
 * @returns {string} The HTML string for the report.
 */
function generateExpensesReport(expenses) {
    if (expenses.length === 0) return '<p class="text-center text-gray-500">No expenses for the selected period</p>';

    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    let categoryExpenses = {};
    expenses.forEach(expense => {
        categoryExpenses[expense.category] = (categoryExpenses[expense.category] || 0) + expense.amount;
    });
    const categoryExpensesArray = Object.entries(categoryExpenses)
        .map(([category, amount]) => ({ category, amount }))
        .sort((a, b) => b.amount - a.amount);

    return `
        <div class="mb-4">
            <h4 class="text-lg font-semibold">Expenses Summary</h4>
            <p>Total Expenses: <strong>${formatCurrency(totalExpenses)}</strong></p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${categoryExpensesArray.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${((item.amount / totalExpenses) * 100).toFixed(2)}%</td>
                    </tr>`).join('')}
            </tbody>
        </table>`;
}

// ===========================
// SETTINGS FUNCTIONALITY
// ===========================

/**
 * Exports all application data to a single Excel file with multiple sheets.
 */
function exportDataToExcel() {
    try {
        const products = getProducts();
        const sales = getSales();
        const suppliers = getSuppliers();
        const expenses = getExpenses();
        const customers = getCustomers();

        const wb = XLSX.utils.book_new();

        const productsSheet = XLSX.utils.json_to_sheet(products);
        XLSX.utils.book_append_sheet(wb, productsSheet, "Products");

        // Flatten sales data for better export, as sales contain nested item arrays
        const flatSales = sales.flatMap(sale =>
            (sale.items || []).map(item => ({
                sale_id: sale.id,
                sale_date: sale.date,
                sale_time: sale.time,
                customer_type: sale.customerType,
                payment_method: sale.paymentMethod,
                product_id: item.productId,
                product_name: item.name,
                quantity: item.quantity,
                price_per_item: item.price,
                item_discount_percent: item.discount,
                item_total: item.total,
                order_total: sale.total,
                order_profit: sale.profit,
                order_discount_percent: sale.orderDiscount,
                notes: sale.notes
            }))
        );
        const salesSheet = XLSX.utils.json_to_sheet(flatSales);
        XLSX.utils.book_append_sheet(wb, salesSheet, "Sales");

        const suppliersSheet = XLSX.utils.json_to_sheet(suppliers);
        XLSX.utils.book_append_sheet(wb, suppliersSheet, "Suppliers");

        const expensesSheet = XLSX.utils.json_to_sheet(expenses);
        XLSX.utils.book_append_sheet(wb, expensesSheet, "Expenses");

        const customersSheet = XLSX.utils.json_to_sheet(customers);
        XLSX.utils.book_append_sheet(wb, customersSheet, "Customers");

        const today = new Date().toISOString().split('T')[0];
        const defaultName = `SwiftPOS_Backup_${today}.xlsx`;

        if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
                suggestedName: defaultName,
                types: [{
                    description: 'Excel Workbook',
                    accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] },
                }],
            });
            const writable = await handle.createWritable();
            const xlsxBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            await writable.write(xlsxBuffer);
            await writable.close();
            showToast('Data exported successfully!', 'success');
        } else {
            // Fallback for older browsers
            XLSX.writeFile(wb, defaultName);
            showToast('Data exported successfully to Excel!', 'success');
        }
    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error("Error exporting data:", error);
            showToast('Failed to export data. See console for details.', 'error');
        }
    }
}

/**
 * Imports data from an Excel file, replacing existing data.
 * @param {File} file The .xlsx file to import.
 */
function importDataFromExcel(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});

            if (!confirm('This will replace all current data. Are you sure you want to proceed?')) {
                return;
            }

            const products = XLSX.utils.sheet_to_json(workbook.Sheets['Products'] || {});
            const salesRaw = XLSX.utils.sheet_to_json(workbook.Sheets['Sales'] || {});
            const suppliers = XLSX.utils.sheet_to_json(workbook.Sheets['Suppliers'] || {});
            const expenses = XLSX.utils.sheet_to_json(workbook.Sheets['Expenses'] || {});
            const customers = XLSX.utils.sheet_to_json(workbook.Sheets['Customers'] || {});

            // Reconstruct sales from flat structure
            const sales = Object.values(salesRaw.reduce((acc, row) => {
                if (!acc[row.sale_id]) {
                    acc[row.sale_id] = {
                        id: row.sale_id,
                        date: row.sale_date,
                        time: row.sale_time,
                        customerType: row.customer_type,
                        paymentMethod: row.payment_method,
                        total: row.order_total,
                        profit: row.order_profit,
                        orderDiscount: row.order_discount_percent,
                        notes: row.notes,
                        items: []
                    };
                }
                acc[row.sale_id].items.push({
                    productId: row.product_id,
                    name: row.product_name,
                    quantity: row.quantity,
                    price: row.price_per_item,
                    discount: row.item_discount_percent,
                    total: row.item_total
                });
                return acc;
            }, {}));

            saveProducts(products);
            saveSales(sales);
            saveSuppliers(suppliers);
            saveExpenses(expenses);
            saveCustomers(customers);

            showToast('Data imported successfully!', 'success');
            // Refresh the whole application state
            showView('dashboard');
        } catch (error) {
            console.error("Error importing data from Excel:", error);
            showToast('Failed to import data. File might be corrupt or in the wrong format.', 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

/**
 * Loads company and system settings into the settings form.
 */
function loadSettings() {
    const companyInfo = getCompanyInfo();
    const systemSettings = getSystemSettings();

    document.getElementById('companyName').value = companyInfo.name || 'Swift POS';
    document.getElementById('companyAddress').value = companyInfo.address || '';
    document.getElementById('companyPhone').value = companyInfo.phone || '';

    document.getElementById('currency').value = systemSettings.currency || 'MMK';
    document.getElementById('taxRate').value = systemSettings.taxRate || 0;
    document.getElementById('enableNotifications').checked = systemSettings.enableNotifications !== false;
    document.getElementById('enableSound').checked = systemSettings.enableSound !== false;

    const storagePref = systemSettings.storagePreference || { type: 'local', path: '' };
    document.querySelector(`input[name="storageType"][value="${storagePref.type}"]`).checked = true;
    document.getElementById('storagePath').value = storagePref.path || '';
}

// ===========================
// EVENT LISTENERS
// ===========================

/**
 * Handles submission of the product form to add or update a product.
 * @param {Event} e The form submission event.
 */
document.getElementById('productForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const products = getProducts();
    const productId = document.getElementById('productId').value;
    const name = document.getElementById('productName').value.trim();
    if (!name) return showToast('Product name is required', 'error');

    const newProduct = {
        id: productId || generateId(),
        name: name,
        category: document.getElementById('productCategory').value,
        stock: parseInt(document.getElementById('productStock').value, 10),
        buyingPrice: parseFloat(document.getElementById('productBuyingPrice').value),
        sellingPrice: parseFloat(document.getElementById('productSellingPrice').value),
        size: document.getElementById('productSize').value.trim(),
        color: document.getElementById('productColor').value.trim(),
        supplierId: document.getElementById('productSupplier').value,
        barcode: document.getElementById('productBarcode').value.trim(),
        image: '' // Image handling needs to be implemented separately
    };

    if (productId) {
        const index = products.findIndex(p => p.id === productId);
        products[index] = newProduct;
    } else {
        products.push(newProduct);
    }
    saveProducts(products);
    loadProducts();
    resetProductForm();
    showToast('Product saved successfully', 'success');
});

/**
 * Handles submission of the supplier form to add or update a supplier.
 * @param {Event} e The form submission event.
 */
document.getElementById('supplierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const suppliers = getSuppliers();
    const supplierId = document.getElementById('supplierId').value;
    const name = document.getElementById('supplierName').value.trim();
    if (!name) return showToast('Supplier name is required', 'error');

    const newSupplier = {
        id: supplierId || generateId(),
        name: name,
        phone: document.getElementById('supplierPhone').value.trim(),
        email: document.getElementById('supplierEmail').value.trim(),
        address: document.getElementById('supplierAddress').value.trim()
    };

    if (supplierId) {
        const index = suppliers.findIndex(s => s.id === supplierId);
        suppliers[index] = newSupplier;
    } else {
        suppliers.push(newSupplier);
    }
    saveSuppliers(suppliers);
    loadSuppliers();
    resetSupplierForm();
    showToast('Supplier saved successfully', 'success');
});

/**
 * Handles submission of the expense form to add or update an expense.
 * @param {Event} e The form submission event.
 */
document.getElementById('expenseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const expenses = getExpenses();
    const expenseId = document.getElementById('expenseId').value;
    const newExpense = {
        id: expenseId || generateId(),
        category: document.getElementById('expenseCategory').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        description: document.getElementById('expenseDescription').value.trim()
    };
    if (!newExpense.category || !newExpense.amount || !newExpense.date) {
        return showToast('Category, amount, and date are required', 'error');
    }

    if (expenseId) {
        const index = expenses.findIndex(ex => ex.id === expenseId);
        expenses[index] = newExpense;
    } else {
        expenses.push(newExpense);
    }
    saveExpenses(expenses);
    loadExpenses();
    resetExpenseForm();
    showToast('Expense saved successfully', 'success');
});

/**
 * Handles submission of the customer form to add or update a customer.
 * @param {Event} e The form submission event.
 */
document.getElementById('customerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const customers = getCustomers();
    const customerId = document.getElementById('customerId').value;
    const name = document.getElementById('customerName').value.trim();
    if (!name) return showToast('Customer name is required', 'error');

    const newCustomer = {
        id: customerId || generateId(),
        name: name,
        phone: document.getElementById('customerPhone').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        address: document.getElementById('customerAddress').value.trim()
    };

    if (customerId) {
        const index = customers.findIndex(c => c.id === customerId);
        customers[index] = newCustomer;
    } else {
        customers.push(newCustomer);
    }
    saveCustomers(customers);
    loadCustomers();
    resetCustomerForm();
    showToast('Customer saved successfully', 'success');
});

/**
 * Handles submission of the report form to generate a new report.
 * @param {Event} e The form submission event.
 */
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!startDate || !endDate) return showToast('Please select both start and end dates', 'error');
    if (new Date(startDate) > new Date(endDate)) return showToast('Start date cannot be after end date', 'error');
    generateReport(reportType, startDate, endDate);
});

/**
 * Handles submission of the company info form.
 * @param {Event} e The form submission event.
 */
document.getElementById('companyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const info = {
        name: document.getElementById('companyName').value.trim(),
        address: document.getElementById('companyAddress').value.trim(),
        phone: document.getElementById('companyPhone').value.trim(),
        logo: getCompanyInfo().logo // Logo saving needs separate logic
    };
    saveCompanyInfo(info);
    showToast('Company information saved', 'success');
    loadDashboardData(); // Refresh dashboard with new name/logo
});

/**
 * Handles submission of the system settings form.
 * @param {Event} e The form submission event.
 */
document.getElementById('systemForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const settings = {
        currency: document.getElementById('currency').value,
        taxRate: parseFloat(document.getElementById('taxRate').value),
        enableNotifications: document.getElementById('enableNotifications').checked,
        enableSound: document.getElementById('enableSound').checked,
        storagePreference: getSystemSettings().storagePreference
    };
    saveSystemSettings(settings);
    showToast('System settings saved', 'success');
});

/**
 * Handles submission of the storage preferences form.
 * @param {Event} e The form submission event.
 */
document.getElementById('storageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const settings = getSystemSettings();
    settings.storagePreference = {
        type: document.querySelector('input[name="storageType"]:checked').value,
        path: document.getElementById('storagePath').value.trim()
    };
    saveSystemSettings(settings);
    showToast('Storage preference saved', 'success');
});

// Button Clicks
document.getElementById('productClearBtn').addEventListener('click', resetProductForm);
document.getElementById('supplierClearBtn').addEventListener('click', resetSupplierForm);
document.getElementById('expenseClearBtn').addEventListener('click', resetExpenseForm);
document.getElementById('customerClearBtn').addEventListener('click', resetCustomerForm);
document.getElementById('clearCartButton').addEventListener('click', clearCart);
document.getElementById('completeSaleButton').addEventListener('click', completeSale);
document.getElementById('printReceiptButton').addEventListener('click', printReceipt);
document.getElementById('exportDataButton').addEventListener('click', exportDataToExcel);

/**
 * Handles the click event for the 'Import Data' button.
 * Creates a file input element to allow the user to select an Excel file for import.
 */
document.getElementById('importDataButton').addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xlsx';
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            importDataFromExcel(file);
        }
    };
    fileInput.click();
});

/**
 * Handles the click event for the 'Reset Data' button.
 * Prompts the user for confirmation and resets all application data.
 */
document.getElementById('resetDataButton').addEventListener('click', () => {
    if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
        localStorage.clear();
        initializeData();
        showView('dashboard');
        showToast('All data has been reset.', 'success');
    }
});

/**
 * Handles the click event for the 'Choose Folder' button for local storage preferences.
 * (Note: Actual folder picking is not possible due to browser security restrictions.
 * This is a placeholder for future enhancements, e.g., with Electron.)
 */
document.getElementById('pickLocalFolderButton').addEventListener('click', () => {
    showToast('Direct folder access is not supported in web browsers.', 'info');
});

// Tab and mobile navigation
Object.entries(tabButtons).forEach(([viewName, button]) => button.addEventListener('click', () => showView(viewName)));
mobileNavSelect.addEventListener('change', (e) => showView(e.target.value));

/**
 * Handles the click event for the mobile menu button to open the sidebar.
 */
mobileMenuButton.addEventListener('click', () => {
    sidebar.classList.add('open');
    overlay.classList.add('open');
});

/**
 * Handles the click event for the close sidebar button.
 */
closeSidebar.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
});

/**
 * Handles the click event for the overlay to close the sidebar.
 */
overlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
});

/**
 * Initializes the application when the DOM is fully loaded.
 * Sets up initial data, views, and event listeners.
 */
document.addEventListener('DOMContentLoaded', function() {
    initializeData();
    showView('dashboard');
    // Set default dates
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
    document.getElementById('startDate').value = firstDay;
    document.getElementById('endDate').value = lastDay;

    // Language and translation logic
    const translations = {
        en: {
            dashboard: 'Dashboard',
            products: 'Products',
            sales: 'Sales',
            suppliers: 'Suppliers',
            expenses: 'Expenses',
            customers: 'Customers',
            reports: 'Reports',
            settings: 'Settings',
            // Add more translations as needed
        },
        my: {
            dashboard: '',
            products: '',
            sales: '',
            suppliers: '',
            expenses: '',
            customers: '',
            reports: '',
            settings: '',
            // Add more translations as needed
        }
    };

    function applyTranslations(lang) {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (translations[lang] && translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
    }

    function setLanguage(lang) {
        const settings = getSystemSettings();
        settings.language = lang;
        saveSystemSettings(settings);
        applyTranslations(lang);
    }

    document.getElementById('language').addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });

    const savedLanguage = getSystemSettings().language || 'en';
    document.getElementById('language').value = savedLanguage;
    applyTranslations(savedLanguage);

    // Online/Offline status
    window.addEventListener('online', () => document.getElementById('offlineIndicator').classList.add('hidden'));
    window.addEventListener('offline', () => document.getElementById('offlineIndicator').classList.remove('hidden'));
    if (!navigator.onLine) document.getElementById('offlineIndicator').classList.remove('hidden');

    // PWA Installation Prompt
    let deferredPrompt;
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI to notify the user they can install the PWA
        installButton.classList.remove('hidden');

        installButton.addEventListener('click', () => {
            // Hide the app provided install promotion
            installButton.classList.add('hidden');
            // Show the install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        });
    });

    window.addEventListener('appinstalled', () => {
        // Hide the install button if the app is installed
        installButton.classList.add('hidden');
        deferredPrompt = null;
        console.log('PWA was installed');
    });
});
</script>
</body>
</html>
